name: Suspicious Process Executed From Container File
id: d8120352-3b62-4e3c-8cb6-7b47584dd5e8
version: 1
date: '2023-06-13'
author: Steven Dick
status: production
type: TTP
description: This analytic identifies a suspicious process spawned by another process from within common container/archive 
file types. This technique was a common technique used by adversaries and malware to execute scripts or evade defenses. 
This TTP may detect some normal software installation or user behaviors where opening archive files is common.
data_source:
- Sysmon 1
- Windows Security 4688
search: '| tstats `security_content_summariesonly` count values(Processes.process_name) as process_name min(_time) as firstTime max(_time) as lastTime 
from datamodel=Endpoint.Processes where Processes.process IN ("*.ZIP\\*","*.ISO\\*","*.IMG\\*","*.CAB\\*","*.TAR\\*","*.GZ\\*","*.RAR\\*","*.7Z\\*") 
AND Processes.action="allowed" by Processes.dest Processes.parent_process Processes.process Processes.user
| `drop_dm_object_name(Processes)`
| regex process="(?i).*(ZIP|ISO|IMG|CAB|TAR|GZ|RAR|7Z)\\\\.+\.(BAT|BIN|CAB|CMD|COM|CPL|EX_|EXE|GADGET|INF1|INS|INX||HTM|HTML|ISU|JAR|JOB|JS|JSE|LNK|MSC|MSI|MSP|MST|PAF|PIF|PS1|REG|RGS|SCR|SCT|SHB|SHS|U3P|VB|VBE|VBS|VBSCRIPT|WS|WSF|WSH)\"?$"
| rex field=process "(?i).+\\\\(?<file_name>[^\\\]+\.(ZIP|ISO|IMG|CAB|TAR|GZ|RAR|7Z))\\\\((.+\\\\)+)?(?<process_name>.+\.(BAT|BIN|CAB|CMD|COM|CPL|EX_|EXE|GADGET|INF1|INS|INX||HTM|HTML|ISU|JAR|JOB|JS|JSE|LNK|MSC|MSI|MSP|MST|PAF|PIF|PS1|REG|RGS|SCR|SCT|SHB|SHS|U3P|VB|VBE|VBS|VBSCRIPT|WS|WSF|WSH))\"?$"
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `suspicious_process_executed_from_container_file_filter`'
how_to_implement: The following analytic requires Sysmon or Windows logging with
command line logging enabled. Use filter to remove known environment known false 
positives prior to full production usage.
known_false_positives: Various business process or userland applications and behavior.
references:
- https://www.mandiant.com/resources/blog/tracking-evolution-gootloader-operations
- https://www.crowdstrike.com/blog/weaponizing-disk-image-files-analysis/
- https://attack.mitre.org/techniques/T1204/002/
tags:
  analytic_story:
  - Unusual Processes
  asset_type: Endpoint
  confidence: 20 
  impact: 80
  message: A suspicious process $process_name$ was launched from $file_name$ on $dest$.
  mitre_attack_id:
  - T1204.002  
  - T1036.008 
  observable:
  - name: dest
    type: hostname
    role:
    - Victim
  - name: user
    type: username
    role:
    - Victim
  - name: file_name
    type: file_name
    role:
    - Attacker
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - _time
  - EventCode
  - ActivityID, 
  - Computer
  - ScriptBlockText
  risk_score: 40
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/malware/gootloader/partial_ttps/i_am_goot.log
    source: XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
    sourcetype: XmlWinEventLog