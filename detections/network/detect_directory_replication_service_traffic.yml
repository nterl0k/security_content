name: Detect Directory Replication Service Traffic
id: b05926f1-0c80-4ac5-b151-587f7f73f44e
version: 1
date: '2022-11-26'
author: Steven Dick
type: Anomaly
datamodel:
- Network_Traffic
- Network_Sessions
description: This search looks for evidence of Active Directory replication traffic [MS-DRSR] from unexpected sources. 
This traffic is often seen exclusively between Domain Controllers for AD database replication. 
Any detections from non-domain controller source to a domain controller may indicate the usage of DCSync or DCShadow credential dumping techniques. 
search: '| tstats `security_content_summariesonly` count values(All_Traffic.transport) as transport values(All_Traffic.user) as user
values(All_Traffic.src_category) as src_category values(All_Traffic.dest_category) as dest_category min(_time) as firstTime max(_time) as lastTime
from datamodel=Network_Traffic where All_Traffic.app IN ("ms-dc-replication","*drsr*","ad drs") by All_Traffic.src All_Traffic.dest All_Traffic.app
| `security_content_ctime(firstTime)` 
| `security_content_ctime(lastTime)` 
| `drop_dm_object_name("All_Traffic")`
| `active_directory_replication_traffic_from_unknown_source_filter` | `detect_directory_replication_service_traffic_filter`'
how_to_implement: To successfully implement this search, you need to be ingesting
  application aware firewall or proxy logs into the Network Datamodel. Categorize 
  all known domain controller Assets servers with an appropriate category for filtering.
known_false_positives: New domain controllers or certian scripts run by administrators.
references:
- https://adsecurity.org/?p=1729
- https://attack.mitre.org/techniques/T1003/006/
- https://attack.mitre.org/techniques/T1207/
tags:
  analytic_story:
  - Credential Dumping
  - Active Directory Replication Attacks
  asset_type: endpoint
  cis20:
  - CIS 4
  - CIS 6
  confidence: 100
  context:
    - Source:Endpoint
    - Stage:Credential Access
  dataset:
  - UPDATE_DATASET_URL
  impact: 100
  kill_chain_phases:
  - Exploitation
  - Actions on Objectives
  message: Active Directory Replication Traffic from Unknown Source - $src$
  mitre_attack_id:
  - T1003
  - T1003.006
  - T1207
  nist:
  - DE.CM
  observable:
  - name: dest
    type: IP Address
    role:
    - Victim
  - name: src
    type: IP Address
    role:
    - Attacker  
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  required_fields:
  - All_Traffic.src
  - All_Traffic.dest
  - All_Traffic.app
  risk_score: 100
  security_domain: network
